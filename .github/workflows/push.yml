name: Push

on:
  push:
    branches: [main]
    paths:
      - "boto3_client_cache/**"
      - "docs/**"
      - "README.md"
      - "pyproject.toml"
      - "LICENSE"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  checks:
    name: Setup, Lint, and Test
    runs-on: ubuntu-latest
    if: ${{ !(github.actor == 'github-actions[bot]' && contains(github.event.head_commit.message, '[skip ci]')) }}
    steps:
      - name: Check-Out Repository
        uses: actions/checkout@v4

      - name: Setup Python
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Check uv lockfile
        if: ${{ hashFiles('uv.lock') != '' }}
        run: uv lock --check

      - name: Cache uv Dependencies
        id: cached-uv-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: uv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/uv.lock', '**/pyproject.toml') }}

      - name: Install Dependencies
        if: steps.cached-uv-dependencies.outputs.cache-hit != 'true'
        run: |
          if [ -f uv.lock ]; then
            uv sync --frozen --all-groups
          else
            uv sync --all-groups
          fi

      - name: Check Formatting with Ruff
        run: uv run ruff format --check .

      - name: Lint with Ruff
        run: uv run ruff check .

      - name: Run Unit Tests
        run: uv run pytest tests/ -v

  changes:
    name: Detect Changed Paths
    needs: checks
    runs-on: ubuntu-latest
    outputs:
      release: ${{ steps.filter.outputs.release }}
      docs_or_code: ${{ steps.filter.outputs.docs_or_code }}
    steps:
      - name: Check-Out Repository
        uses: actions/checkout@v4

      - name: Detect changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            release:
              - "boto3_client_cache/**"
              - "README.md"
              - "pyproject.toml"
              - "LICENSE"
            docs_or_code:
              - "boto3_client_cache/**"
              - "docs/**"

  release:
    name: Release Please and Publish to PyPI
    needs: [checks, changes]
    runs-on: ubuntu-latest
    if: needs.changes.outputs.release == 'true'
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - name: Run release-please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: configs/release-please-config.json
          manifest-file: configs/.release-please-manifest.json

      - name: Check-Out Repository at Released SHA
        if: steps.release.outputs.release_created == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.release.outputs.sha }}

      - name: Setup Python
        if: steps.release.outputs.release_created == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install uv
        if: steps.release.outputs.release_created == 'true'
        uses: astral-sh/setup-uv@v5

      - name: Build and publish package to PyPI
        if: steps.release.outputs.release_created == 'true'
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          uv build
          uv publish

  docs:
    name: Build and Deploy Docs
    needs: [checks, changes, release]
    runs-on: ubuntu-latest
    if: |
      always() &&
      needs.changes.outputs.docs_or_code == 'true' &&
      (needs.release.result == 'success' || needs.release.result == 'skipped')
    permissions:
      contents: write
    steps:
      - name: Check-Out Repository
        uses: actions/checkout@v4

      - name: Setup Python
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Cache uv Dependencies
        id: cached-uv-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: uv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/uv.lock', '**/pyproject.toml') }}

      - name: Install Dependencies
        if: steps.cached-uv-dependencies.outputs.cache-hit != 'true'
        run: |
          if [ -f uv.lock ]; then
            uv sync --frozen --all-groups
          else
            uv sync --all-groups
          fi

      - name: Build docs
        run: uv run --directory docs make clean html

      - name: Disable Jekyll for built docs directory
        run: touch docs/_build/html/.nojekyll

      - name: Deploy docs to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          publish_branch: gh-pages
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: docs/_build/html
          destination_dir: docs
          enable_jekyll: false
          force_orphan: true
